<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offline Field Invoice</title>
  <style>
    body {
      margin: 0;
      font-family: 'SF Pro', sans-serif;
      background: #f2f2f2;
      color: #222;
    }
    .main-wrap {
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .form-card {
      background: #fff;
      border-radius: 20px;
      padding: 30px 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      max-width: 500px;
      width: 100%;
    }
    .form-title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 18px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      background: #fafafa;
    }
    .save-btn {
      width: 100%;
      background: #FF5F15;
      color: white;
      font-weight: bold;
      padding: 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .file-pill {
      border: 1.5px dashed #28a745;
      color: #28a745;
      padding: 6px 14px;
      border-radius: 999px;
      margin: 6px 4px;
      display: inline-block;
      background-color: rgba(40, 167, 69, 0.08);
    }
  </style>
</head>
<body>
  <div class="main-wrap">
    <div class="form-card">
      <div class="form-title">Field Invoice (Offline)</div>
      <form id="offlineInvoiceForm">
        <div class="form-group">
          <label class="form-label">Invoice #</label>
          <input class="form-input" id="invoiceNumber" required />
        </div>
        <div class="form-group">
          <label class="form-label">Invoice Date</label>
          <input class="form-input" type="date" id="invoiceDate" required />
        </div>
        <div class="form-group">
          <label class="form-label">Company</label>
          <select class="form-select" id="companySelect" required>
            <option value="">Select Company...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Contact</label>
          <select class="form-select" id="contactSelect" required>
            <option value="">Select Contact...</option>
            <option value="new">+ New Contact</option>
          </select>
        </div>
        <div id="newContactFields" class="form-group" style="display: none;">
          <input placeholder="First Name" class="form-input" id="newContactFirstName" />
          <input placeholder="Last Name" class="form-input" id="newContactLastName" />
          <input placeholder="Mobile" class="form-input" id="newContactMobile" />
          <input placeholder="Email" class="form-input" id="newContactEmail" />
        </div>
        <div class="form-group">
          <label class="form-label">Approver Number</label>
          <input class="form-input" id="approverNumber" />
        </div>
        <div class="form-group">
          <label class="form-label">AFE Number</label>
          <input class="form-input" id="afeNumber" />
        </div>
        <div class="form-group">
          <label class="form-label">Submitted By</label>
          <input class="form-input" id="submittedBy" disabled />
        </div>
        <div class="form-group">
          <label class="form-label">Comments</label>
          <textarea class="form-textarea" id="comments"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Upload Files</label>
          <input type="file" id="fileInput" multiple />
          <div id="fileList"></div>
        </div>
        <button type="submit" class="save-btn">Save Offline</button>
      </form>
    </div>
  </div>

  <script>
    let fileArray = [];

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const fileList = document.getElementById('fileList');
      fileArray = [];
      fileList.innerHTML = '';
      
      Array.from(event.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          fileArray.push({ name: file.name, body: e.target.result });
          const pill = document.createElement('div');
          pill.className = 'file-pill';
          pill.textContent = file.name;
          fileList.appendChild(pill);
        };
        reader.readAsDataURL(file);
      });
    });

    document.getElementById('offlineInvoiceForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = {
        invoiceNumber: document.getElementById('invoiceNumber').value,
        invoiceDate: document.getElementById('invoiceDate').value,
        companyId: document.getElementById('companySelect').value,
        contactId: document.getElementById('contactSelect').value,
        approverNumber: document.getElementById('approverNumber').value,
        afeNumber: document.getElementById('afeNumber').value,
        submittedBy: document.getElementById('submittedBy').value,
        comments: document.getElementById('comments').value,
        files: fileArray,
        newContact: (document.getElementById('contactSelect').value === 'new') ? {
          firstName: document.getElementById('newContactFirstName').value,
          lastName: document.getElementById('newContactLastName').value,
          mobile: document.getElementById('newContactMobile').value,
          email: document.getElementById('newContactEmail').value
        } : null
      };
      localStorage.setItem('offline_invoice_data', JSON.stringify(formData));
      alert('✅ Invoice saved offline. It will sync once you’re online.');
    });

    document.addEventListener('DOMContentLoaded', function () {
      const companySelect = document.getElementById('companySelect');
      const contactSelect = document.getElementById('contactSelect');
      const newContactFields = document.getElementById('newContactFields');

      const companies = JSON.parse(localStorage.getItem('company_list') || '[]');
      companies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        companySelect.appendChild(opt);
      });

      companySelect.addEventListener('change', () => {
        const selectedCompany = companySelect.value;
        const contacts = JSON.parse(localStorage.getItem('contact_list') || '[]');
        contactSelect.innerHTML = '<option value="">Select Contact...</option>';
        contacts.filter(c => c.companyId === selectedCompany).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          contactSelect.appendChild(opt);
        });
        const newOpt = document.createElement('option');
        newOpt.value = 'new';
        newOpt.textContent = '+ New Contact';
        contactSelect.appendChild(newOpt);
      });

      contactSelect.addEventListener('change', () => {
        newContactFields.style.display = contactSelect.value === 'new' ? 'block' : 'none';
      });

      document.getElementById('submittedBy').value = localStorage.getItem('offline_contact_name') || '';
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./serviceWorker.js')
        .then(reg => console.log('✅ Service Worker registered:', reg))
        .catch(err => console.error('❌ Service Worker failed:', err));
    }
  </script>
</body>
</html>
